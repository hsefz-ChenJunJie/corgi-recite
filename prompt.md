# Corgi Recite 项目开发文档

## 项目概述
`corgi-recite` 是一个基于Flutter的词语背诵和测试应用，支持批量添加词语、智能背诵模式、双向测试和错误重学机制。

## 项目开发

本项目在MacOS环境下开发和测试。

---

### **✅ 已完成：环境与项目创建**

**完成状态**：✅ 已完成
- ✅ 配置Flutter开发环境（通过Homebrew安装Flutter 3.32.4）
- ✅ 创建corgi_recite Flutter项目
- ✅ 使用github-cli创建GitHub仓库 `corgi-recite`
- ✅ 完成初始代码推送

---

### **✅ 已完成：核心功能循环**

**完成状态**：✅ 已完成并优化
- ✅ 批量添加词语功能（支持`词语=意项`格式的批量输入）
- ✅ SQLite数据库持久化存储
- ✅ 添加后强制进入背诵模式（只背诵本次新添加的词语）
- ✅ 背诵后自动进入双向默写测试
  - 第一阶段：按顺序完成所有"词语→意项"
  - 第二阶段：按顺序完成所有"意项→词语"
- ✅ 独立的随机抽查模式（用户可自定义抽查数量：1-全部）
- ✅ 错误处理机制：
  - 背诵后测试错误：强制重新背诵错词
  - 随机抽查错误：强制重新背诵错词，完成后进入双向测试
- ✅ 实时答案验证和按钮状态更新

**技术实现**：
- 数据模型：`WordItem` 类
- 数据库：`DatabaseHelper` 使用SQLite
- 界面组件：`HomeScreen`, `AddWordScreen`, `ReciteScreen`, `QuizScreen`
- 导航流程：确保数据刷新和状态同步

**已提交**：commit "feat: Implement core recitation and quiz functionality"

**主要修复和优化**：
- 修复抽查中提交答案按钮不响应问题（添加实时监听器）
- 实现批量添加词语功能（替代单个添加）
- 优化错误处理逻辑（错误时强制重新背诵）
- 实现自定义抽查数量功能
- 修复主界面数据刷新问题
- 优化用户交互流程（强制背诵，移除跳过选项）

---

### **✅ 已完成：错误处理增强与版本控制**

**完成状态**：✅ 已完成并测试
- ✅ 立即错误处理机制
  - 双向测试中答错立即保存进度并返回背诵
  - 背诵完成后自动恢复到原测试进度继续
  - 修复双向测试第一阶段完成后无法进入第二阶段的问题
- ✅ 进度保存和恢复系统
  - 完整的测试状态保存（当前题目、正确数、阶段信息等）
  - 错误词语列表的持久化
  - 从保存进度准确恢复测试状态
- ✅ 版本控制系统
  - 测试版：显示返回按钮方便调试
  - 正式版：隐藏学习流程中的返回按钮，强制完成
  - 添加页面在两个版本中都保留返回按钮
- ✅ 用户体验优化
  - 区分随机抽查和双向测试的错误处理策略
  - 双向测试完成后提供可选的重新背诵错词选项
  - 随机抽查保持强制背诵错词机制
  - 改进错误提示对话框，提供清晰的下一步指引

**技术实现**：
- 配置管理：`AppConfig` 类控制版本行为
- 状态管理：完整的Quiz状态序列化/反序列化
- 导航优化：智能的界面跳转和进度恢复
- 错误分类：不同测试类型的差异化错误处理

**已提交**：commit "feat: Enhance quiz system with immediate error handling and version control"

**核心问题解决**：
1. **双向测试进度丢失**：实现了完整的状态保存和恢复机制
2. **错误处理不及时**：从"完成后处理"改为"立即处理"
3. **版本发布复杂**：通过配置开关简化测试版/正式版切换
4. **阶段判断错误**：修复了从保存进度恢复时的阶段检测逻辑

**开发经验总结**：
- **状态管理的重要性**：复杂的用户流程需要精确的状态保存和恢复
- **版本控制策略**：通过配置文件控制功能开关，便于测试和发布
- **用户体验设计**：不同场景下的错误处理需要不同的策略
- **Git配置技巧**：多SSH密钥环境下需要正确配置git的sshCommand
- **渐进式开发**：先实现基础功能，再逐步增强错误处理和边界情况

---

### **✅ 已完成：多对多关系与智能测试系统**

**完成状态**：✅ 已完成并测试
- ✅ 词语与意项之间的多对多关系数据库架构
- ✅ 智能背诵系统（同词语多意项合并显示）
- ✅ 智能测试系统（同页完成相关内容测试）
- ✅ 双向测试流程（添加后：背诵 → 双向测试）
- ✅ 随机抽查优化（按意项抽查，多词语同页测试）

**技术实现**：
- 数据库：`words`、`meanings`、`word_meanings`三表结构
- 数据模型：`Word`、`Meaning`、`WordMeaning`、`WordMeaningPair`
- 服务层：`QuizService`、`ReciteService`智能处理逻辑
- 界面层：`SmartQuizScreen`、`SmartReciteScreen`适配多对多关系
- 自动迁移：旧数据无缝升级到新结构

**已提交**：commit "feat: Add many-to-many relationships and smart testing system"

**核心问题解决**：
1. **多对多关系**：实现了词语与意项的灵活多对多关系
2. **智能背诵**：一个词语的多个意项在同一页显示，避免重复分页
3. **智能测试**：
   - 词语→意项：一个词语的所有意项在同一页测试
   - 意项→词语：一个意项的所有词语在同一页测试
4. **正确流程**：添加后进入双向测试而非随机抽查
5. **数据智能处理**：自动去重和聚合，用户仍使用简单的`词语=意项`格式

**开发经验总结**：
- **数据库设计的前瞻性**：多对多关系需要三表结构，但要保持API简单
- **用户体验一致性**：后台复杂逻辑不应影响前台操作简洁性
- **渐进式重构**：保持向后兼容，新旧系统并行，平滑迁移
- **分层架构优势**：Service层处理复杂逻辑，Screen层专注UI交互
- **智能分组策略**：按业务逻辑（词语/意项）分组，而非简单按条目分页

---

### **✅ 已完成：指定内容抽查功能**

**完成状态**：✅ 已完成并测试
- ✅ 智能搜索界面（支持词语和意项的实时模糊搜索）
- ✅ 多选操作功能（单选、全选、批量选择，丰富的视觉反馈）
- ✅ 指定抽查测试（选中内容进行专项抽查，形式与随机抽查相同）
- ✅ 版本控制集成（测试版显示功能，正式版隐藏，保持界面简洁）
- ✅ 智能分组测试（按意项分组，相同意项的多个词语在同页测试）

**技术实现**：
- 搜索界面：`SearchQuizScreen` 提供完整的搜索和选择体验
- 服务扩展：`QuizService.getSpecificQuizItems()` 处理指定内容的测试逻辑
- 测试系统：`SmartQuizScreen` 支持多种测试模式（随机、双向、指定）
- 主界面集成：`HomeScreen` 添加橙色指定抽查按钮，版本控制显示
- 无缝复用：完全集成现有错误处理、进度保存等机制

**已提交**：commit "feat: Add specific content quiz functionality for test version"

**核心问题解决**：
1. **版本差异管理**：通过 `AppConfig.isDebugVersion` 实现测试版和正式版的功能差异
2. **搜索性能优化**：实时过滤大量数据，使用本地搜索避免频繁数据库查询
3. **选择状态管理**：使用 Set 数据结构高效管理选中状态，支持快速增删操作
4. **测试逻辑复用**：扩展现有智能测试系统，保持代码架构一致性和维护性

**开发经验总结**：
- **任务分解管理**：使用 TodoWrite 工具进行详细的任务规划和进度跟踪，确保开发节奏
- **用户体验设计**：橙色指定抽查按钮与蓝色随机抽查形成视觉对比，测试版双按钮布局
- **搜索体验优化**：实时搜索过滤、搜索状态提示、结果统计显示，提升用户操作体验
- **选择交互设计**：多种选择方式（点击卡片、复选框、全选按钮）配合丰富的视觉反馈
- **版本编译策略**：开发完成后同时编译测试版和正式版进行功能验证和用户体验对比
- **渐进式开发**：先实现核心搜索和选择功能，再优化用户体验和视觉设计
- **代码复用原则**：最大化复用现有智能测试系统，避免重复实现相似逻辑

---

### **✅ 已完成：多选删除功能与确认页面优化**

**完成状态**：✅ 已完成并测试
- ✅ 多对多关系的完整删除功能，支持级联删除逻辑
- ✅ 多选删除界面，支持批量操作和全选功能
- ✅ 确认页面替代简单对话框，提供取消选项
- ✅ 数据一致性保证，取消时自动回滚数据
- ✅ 完善的用户体验设计和错误处理机制

**技术实现**：
- 数据库操作：`DatabaseHelper.deleteWordMeaningPair()` 和 `deleteWordMeaningPairs()`
- 界面状态：`HomeScreen` 多选模式，选择状态管理和视觉反馈
- 确认流程：`ConfirmWordsScreen` 独立确认页面，支持取消和数据回滚
- 级联删除：删除关联关系后自动清理无关联的词语和意项
- 事务安全：使用数据库事务确保删除操作的原子性

**已提交**：commit "feat: Implement multi-selection delete and confirm page with cancel option"

**核心问题解决**：
1. **多对多关系删除**：实现了完整的级联删除逻辑，保持数据一致性
2. **用户体验平衡**：既支持批量删除提高效率，又提供确认和取消保障安全性
3. **数据回滚机制**：用户取消添加时自动删除已保存数据，避免脏数据
4. **异步操作安全**：正确处理BuildContext在异步操作中的使用
5. **编译策略管理**：明确区分测试版(--debug)和正式版(--release)编译

**开发经验总结**：
- **功能设计平衡**：强制学习流程与用户自主选择的平衡
- **数据操作原子性**：保存和删除操作成对出现，确保数据完整性
- **状态管理策略**：使用Set高效管理选中状态，支持复杂的多选操作
- **用户界面设计**：选择模式的视觉反馈和操作直观性
- **错误边界处理**：异步操作每个环节的适当错误处理和用户提示
- **代码质量保证**：异步Context安全检查，避免内存泄漏

---

### **🔄 进行中：双向测试错误处理和上下文感知功能优化**

**完成状态**：🔄 主要问题已修复，上下文感知功能集成待完善
- ✅ 四种元信息输入格式支持：{}占位符、[]介词、|多关键词、()词性
- ✅ 智能文本解析和上下文信息提取
- ✅ 填空题生成和传统问答混合测试
- ✅ 数据库架构扩展到v3，支持上下文信息存储
- ✅ 完整的添加、测试、验证流程
- ✅ 双向测试错误处理重复测试问题修复：背诵后直接返回原测试继续
- ✅ 添加词语页面UI修复：输入框提示词溢出问题已解决
- ✅ 四种元信息差异化填空策略架构完成
- 🔄 待完成：SmartQuizScreen中上下文感知功能集成

**本次修复内容**：
1. **双向测试错误处理完善**：
   - 修复重复测试问题：添加`isImmediateReview`参数区分立即复习模式
   - 立即复习完成后直接返回原测试，避免创建新的双向测试
   - 修改`_resumeQuizAfterReview()`让用户重新作答当前错题而非跳过
   - 优化错误处理流程，提升学习连贯性

2. **UI体验改进**：
   - 修复添加词语页面输入框提示文字溢出问题
   - 简化hintText内容，添加hintMaxLines限制，确保界面美观

3. **四种元信息差异化填空策略完整实现**：
   - 完成BlankType枚举扩展，添加regular类型
   - 实现`_extractNonSpecialWords()`方法提取常规文本
   - 完成四种元信息的差异化处理策略：
     * 词性：任何默写中都显示，不要求填空
     * 不定代词：给出答案中的不定代词，只要求填空其他内容
     * 介词：意项→词语只需填空介词和多关键词，给出其他内容
     * 多关键词：词语→意项显示所有，意项→词语只填空关键词和介词

**未完成问题**：
1. **上下文感知功能集成**：SmartQuizScreen仍使用QuizService，需集成ContextQuizService
2. **测试系统不统一**：随机抽查使用QuizScreen，添加词语使用SmartQuizScreen，两套不同逻辑
3. **上下文检测缺失**：现有测试界面无法自动检测和应用上下文信息

**下一步开发计划**：
1. 在SmartQuizScreen中集成上下文感知检测和填空界面生成
2. 统一所有测试入口使用相同的测试系统
3. 完整测试四种元信息的差异化策略效果
4. 重构测试服务，合并QuizService和ContextQuizService的重复逻辑

**技术实现**：
- 数据模型：`ContextInfo`、`Placeholder`、`Preposition`、`BlankQuizItem`、`BlankAnswer`
- 解析器：`ContextParser` - 智能文本解析和方向性填空题生成
- 服务层：`ContextQuizService` - 上下文感知测试管理
- 界面层：`ContextQuizScreen` - 混合测试界面，`AddWordScreen` - 支持新格式输入
- 数据库：新增 `context_info` 表，支持元信息存储和关联

**输入格式示例**：
- 占位符：`give {something} [to] {someone}=给某人某物`
- 介词：`look [at] the sky=看天空`
- 多关键词：`big|large|huge=巨大的`
- 词性：`run (v.)=跑步`

**填空策略设计**：
1. **词性**：任何默写中都显示，不要求填空
2. **不定代词**：给出答案中的不定代词，只要求填空其他内容
3. **介词**：意项→词语测试中只需填空介词和多关键词，直接给出其他内容
4. **多关键词**：词语→意项显示所有关键词；意项→词语显示除关键词和介词外的内容，只需填空关键词和介词

**开发经验总结**：
- **立即错误处理**：比批量错误处理用户体验更好，能及时强化学习效果
- **UI细节重要性**：小的UI问题会显著影响用户体验，需要重视布局细节
- **枚举统一管理**：跨文件的枚举定义需要统一管理，避免重复定义冲突
- **渐进式重构**：复杂功能重构需要保持向后兼容，先实现新接口再逐步迁移
- **参数化设计**：同一功能在不同场景下需要不同策略，需要参数化处理
- **分层架构优势**：Parser→Service→Screen→Database的清晰分层便于维护和扩展

---

### **✅ 已完成：数据可移植性**

**完成状态**：✅ 已完成并测试
- ✅ 完整的数据导入导出功能，支持词库备份和迁移
- ✅ JSON格式导出，包含版本信息和时间戳
- ✅ 智能导入处理，自动去重并处理数据冲突
- ✅ 直观的数据管理界面，实时显示统计信息
- ✅ UTF-8编码支持，正确处理中文字符
- ✅ MacOS平台兼容性，完整的权限配置

**技术实现**：
- 数据服务：`DataPortService` - 专业的导入导出处理逻辑
- 管理界面：`DataPortScreen` - 用户友好的数据管理界面
- 权限配置：MacOS entitlements文件配置文件访问权限
- 编码处理：使用utf8.decode()确保中文字符正确处理
- 错误处理：完整的验证、提示和异常处理机制

**已提交**：commit "feat: Implement data import and export"

**核心问题解决**：
1. **MacOS权限问题**：配置entitlements文件添加文件访问权限
2. **文件选择器兼容性**：多种fallback方案确保file_picker正常工作
3. **中文字符乱码**：使用utf8.decode()替代String.fromCharCodes()
4. **数据冲突处理**：智能去重算法，详细的导入统计报告
5. **用户体验优化**：滚动界面、进度提示、友好的错误信息

**开发经验总结**：
- **MacOS开发注意事项**：沙盒权限配置对文件操作至关重要
- **编码处理最佳实践**：Flutter中处理UTF-8文件必须使用正确的解码方法
- **文件选择器兼容性**：不同平台的file_picker行为差异需要多种备选方案
- **调试日志的价值**：详细的调试信息快速定位问题根源
- **渐进式问题解决**：从权限到编码到用户体验，层层解决复杂问题
- **测试文件生成**：为功能验证创建包含中文字符的标准测试文件
- **错误处理分层**：界面层、服务层、数据层分别处理不同类型的错误

---

## 技术架构总结

### 数据层
- **数据库**：SQLite (sqflite 2.4.2，当前版本v3)
- **数据模型**：
  - 传统模型：`WordItem` (词语-意项对，向后兼容)
  - 多对多模型：`Word`、`Meaning`、`WordMeaning`、`WordMeaningPair`
  - 上下文模型：`ContextInfo`、`Placeholder`、`Preposition`、`BlankQuizItem`、`BlankAnswer`
- **数据助手**：`DatabaseHelper` (单例模式，支持自动迁移和上下文信息管理)

### 服务层
- **测试服务**：`QuizService` - 智能测试逻辑，支持多对多关系
- **背诵服务**：`ReciteService` - 智能背诵逻辑，合并同词语多意项
- **数据服务**：`DataPortService` - 数据导入导出，支持备份和迁移
- **上下文服务**：`ContextQuizService` - 上下文感知测试管理，支持填空题和传统题混合
- **解析服务**：`ContextParser` - 智能文本解析，支持四种元信息提取和填空题生成

### 界面层
- **主界面**：`HomeScreen` - 词语列表、随机抽查和指定抽查入口，数据管理入口
- **添加界面**：`AddWordScreen` - 批量添加词语（简单格式，后台智能处理）
- **搜索界面**：`SearchQuizScreen` - 指定内容抽查，支持搜索和多选（测试版专属）
- **数据管理界面**：`DataPortScreen` - 数据导入导出，统计信息展示
- **背诵界面**：
  - 传统：`ReciteScreen` - 支持进度恢复
  - 智能：`SmartReciteScreen` - 多意项合并显示
- **测试界面**：
  - 传统：`QuizScreen` - 支持状态保存和恢复
  - 智能：`SmartQuizScreen` - 多对多关系测试，支持随机、双向、指定三种模式
  - 上下文：`ContextQuizScreen` - 上下文感知测试，支持填空题和传统题混合

### 配置层
- **应用配置**：`AppConfig` - 版本控制和功能开关管理

### 核心功能流程
1. **智能添加流程**：
   - 批量输入（`词语=意项`格式）→ 后台智能建立多对多关系 → 确认对话框
   - → 智能背诵（同词语多意项合并显示）→ 双向测试（两阶段完整测试）→ 返回主界面
2. **智能随机抽查**：
   - 选择数量 → 按意项抽查（一个意项的多个词语同页测试）→ 错误处理（重新背诵）
3. **指定内容抽查**：
   - 搜索选择 → 多选确认 → 按意项分组测试（相同抽查形式）→ 错误处理（重新背诵）
4. **智能错误重学**：收集错词 → 智能背诵 → 双向测试
5. **立即错误处理**：答错 → 保存进度 → 立即背诵 → 恢复进度继续测试
6. **双向测试系统**：
   - 第一阶段：词语 → 意项（同词语多意项同页）
   - 第二阶段：意项 → 词语（同意项多词语同页）
7. **数据管理流程**：
   - 导出：数据统计 → 生成JSON文件 → 分享备份文件
   - 导入：文件选择 → UTF-8解码 → 数据验证 → 智能去重 → 统计报告
8. **版本控制**：测试版（有返回按钮，显示指定抽查）↔ 正式版（强制完成流程，隐藏调试功能）
9. **上下文感知测试流程**：
   - 添加：支持四种元信息格式输入 → 智能解析和存储上下文信息
   - 测试：自动检测上下文信息 → 生成填空题或传统题 → 智能验证答案
   - 混合模式：同一测试中可包含填空题和传统题，无缝切换

### 经验总结
- **用户体验**：强制完成学习流程，避免半途而废；测试版提供调试功能，正式版保持简洁
- **错误处理**：及时发现问题并强制重学，确保学习效果
- **数据同步**：合理的导航设计确保界面数据及时刷新
- **批量操作**：提高输入效率，支持格式化批量添加
- **状态管理**：复杂流程需要完整的状态保存和恢复机制
- **版本控制**：通过配置开关管理测试和生产环境的差异，实现功能分级
- **搜索优化**：实时本地搜索避免频繁数据库查询，提升响应速度
- **任务管理**：使用TodoWrite工具进行任务分解和进度跟踪，提高开发效率
- **代码复用**：最大化复用现有系统架构，保持代码一致性和可维护性
- **渐进开发**：从基础功能到复杂场景的逐步完善，每个功能模块独立可测试
- **平台兼容性**：MacOS环境下的权限配置和文件操作需要特殊处理
- **编码处理**：UTF-8编码在跨平台应用中的重要性，正确处理中文字符
- **调试策略**：详细的调试日志帮助快速定位和解决复杂问题