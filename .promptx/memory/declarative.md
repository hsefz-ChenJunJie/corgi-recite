# 陈述性记忆

## 高价值记忆（评分 ≥ 7）

- 2025/06/22 16:38 START
corgi-recite项目多对多关系开发经验总结：

## 本次开发要点
1. **数据库设计的前瞻性**：实现了词语与意项的多对多关系，使用三表结构（words、meanings、word_meanings），但保持API简单
2. **用户体验一致性**：后台复杂逻辑不影响前台操作简洁性，用户仍使用"词语=意项"格式
3. **渐进式重构**：保持向后兼容，新旧系统并行，平滑迁移
4. **分层架构优势**：Service层处理复杂逻辑，Screen层专注UI交互
5. **智能分组策略**：按业务逻辑（词语/意项）分组，而非简单按条目分页

## 技术架构要点
- 数据库版本升级机制：从v1升级到v2，自动迁移旧数据
- 多对多关系处理：一个词语可对应多个意项，一个意项可对应多个词语
- 智能测试逻辑：同一词语的多意项在同页测试，同一意项的多词语在同页测试
- 批量处理优化：支持复杂的批量输入格式，自动解析和建立关联

## 关键问题解决
1. 数据迁移：完整的旧数据迁移逻辑，确保用户数据不丢失
2. 重复处理：智能处理重复的词语和意项，避免数据冗余
3. 测试流程：从随机抽查改为双向测试，提高学习效果
4. 性能优化：使用Transaction确保批量操作的原子性和性能 --tags flutter sqlite 数据库设计 多对多关系 版本迁移 智能测试
--tags #流程管理 #评分:8 #有效期:长期
- END



- 2025/06/22 17:00 START
corgi-recite项目指定内容抽查功能开发经验总结：

## 功能设计要点
1. **版本控制策略**：使用AppConfig.isDebugVersion控制功能显示，测试版显示指定抽查，正式版隐藏
2. **用户体验设计**：橙色指定抽查按钮与蓝色随机抽查形成视觉对比，测试版双按钮布局
3. **搜索体验优化**：实时搜索过滤、关键词高亮、搜索状态提示
4. **选择交互设计**：多种选择方式（点击卡片、复选框、全选按钮）、视觉反馈丰富

## 技术架构特点
- **SearchQuizScreen**：独立的搜索选择界面，完整的搜索和多选功能
- **智能分组逻辑**：QuizService.getSpecificQuizItems()按意项分组，避免重复测试
- **参数扩展**：SmartQuizScreen支持多种测试模式（随机、双向、指定）
- **无缝集成**：复用现有错误处理、进度保存等机制

## 关键问题解决
1. **版本差异管理**：通过配置开关实现测试版和正式版的功能差异
2. **搜索性能**：实时过滤大量数据，使用本地搜索避免数据库查询
3. **选择状态管理**：Set数据结构管理选中状态，支持高效的增删操作
4. **测试逻辑复用**：扩展现有智能测试系统，保持代码一致性

## 开发流程优化
- 任务分解：使用TodoWrite工具进行任务规划和进度跟踪
- 渐进开发：先实现核心功能，再优化用户体验
- 版本编译：开发完成后同时编译测试版和正式版进行对比验证
- 及时提交：功能完成后立即commit和push，保持版本历史清晰 --tags flutter 搜索功能 多选界面 版本控制 用户体验设计
--tags #流程管理 #工具使用 #评分:8 #有效期:长期
- END

- 2025/06/22 17:12 START
corgi-recite项目开发环境信息：用户在MacOS环境下开发和测试，需要构建MacOS版本的应用进行功能验证。项目支持多平台，但主要开发和测试平台是MacOS。 --tags corgi-recite 开发环境 MacOS 测试环境
--tags #其他 #评分:8 #有效期:长期
- END

- 2025/06/22 17:42 START
corgi-recite项目数据导入导出编码问题修复经验：

## 问题描述
在MacOS环境下，导入JSON文件时中文字符出现乱码，导致意项显示异常。

## 根本原因
1. 使用String.fromCharCodes()读取bytes数据时没有正确处理UTF-8编码
2. 文件读写操作没有明确指定UTF-8编码

## 解决方案
1. **导入修复**：
   - 将String.fromCharCodes(platformFile.bytes!)改为utf8.decode(platformFile.bytes!)
   - 文件路径读取时明确指定编码：file.readAsString(encoding: utf8)

2. **导出修复**：
   - 文件写入时明确指定编码：file.writeAsString(data, encoding: utf8)
   - 添加中文字符数量验证以确保编码正确

3. **调试验证**：
   - 添加中文字符数量统计：jsonString.runes.where((rune) => rune >= 0x4E00 && rune <= 0x9FFF).length
   - 通过日志确认UTF-8解码正常工作

## 关键要点
- 在Flutter中处理文件的字节数据时，必须使用utf8.decode()而不是String.fromCharCodes()
- 所有文件读写操作都应明确指定UTF-8编码
- MacOS文件权限配置对file_picker正常工作至关重要 --tags flutter 编码问题 UTF-8 中文乱码 文件处理 MacOS file_picker
--tags #其他 #评分:8 #有效期:长期
- END

- 2025/06/22 18:04 START
corgi-recite项目多对多关系删除功能和确认页面开发经验总结：

## 开发完成内容
1. **多对多关系删除功能**：
   - 在DatabaseHelper中新增deleteWordMeaningPair()和deleteWordMeaningPairs()方法
   - 实现级联删除逻辑：删除关联关系后检查词语和意项是否还有其他关联，无关联则自动删除
   - 支持单个删除和批量删除两种模式

2. **多选删除功能**：
   - 添加选择模式状态管理（_isSelectionMode和_selectedItems）
   - 改进AppBar，在选择模式下显示选中数量和操作按钮
   - 实现全选/取消全选功能
   - ListTile支持选择模式，显示复选框和高亮选中项

3. **确认页面优化**：
   - 创建ConfirmWordsScreen替代简单的对话框
   - 美观的确认界面，显示添加的词语列表和数量统计
   - 提供"稍后背诵"和"立即开始背诵"两个选项
   - 使用导航而非对话框，提供更好的用户体验

## 技术实现要点
- **Transaction使用**：删除操作使用数据库事务确保数据一致性
- **级联删除逻辑**：智能判断词语和意项是否还有其他关联关系
- **状态管理**：使用Set管理选中项索引，支持高效的增删操作
- **UI状态切换**：选择模式和普通模式的界面自动切换
- **Context安全**：在异步操作中正确使用mounted检查避免内存泄漏

## 用户体验改进
- **视觉反馈**：选中项高亮显示，选择模式下显示复选框
- **操作直观**：多选删除通过图标按钮触发，全选/取消全选一键切换
- **确认体验**：从简单对话框升级为完整的确认页面，显示详细信息
- **操作安全**：删除前显示确认对话框，避免误操作

## 开发经验
- **功能渐进**：先实现单个删除，再扩展到批量删除
- **数据一致性**：多对多关系的删除需要考虑级联影响
- **UI适配**：新旧系统（_useNewSystem）的界面适配保持一致
- **错误处理**：完善的try-catch和用户提示机制
- **代码复用**：选择模式逻辑在新旧系统中都可使用 --tags flutter 多对多关系 删除功能 多选操作 确认页面 用户体验 数据库事务
--tags #其他 #评分:8 #有效期:长期
- END

- 2025/06/22 18:13 START
corgi-recite项目确认页面取消功能开发经验：

## 功能实现
1. **确认页面取消选项**：
   - 添加AppBar返回按钮，支持返回修改
   - 添加底部"取消添加"按钮，提供明确的取消选项
   - 使用不同的返回值区分"开始背诵"(true)和"取消添加"('cancel')

2. **数据一致性处理**：
   - 用户取消时自动删除已保存的数据，确保数据库干净
   - 使用已有的deleteWordMeaningPairs()方法清理数据
   - 完整的错误处理和用户提示

3. **用户体验设计**：
   - 双重取消入口：AppBar返回按钮 + 底部取消按钮
   - 视觉层次：开始背诵按钮占2/3宽度，强调主要操作
   - 操作反馈：取消后显示"已取消添加"提示

## 技术要点
- **异步Context安全**：在async操作后使用BuildContext时必须检查mounted
- **数据回滚机制**：取消操作时删除已保存数据，保持数据一致性
- **版本编译策略**：测试版用--debug，正式版用--release
- **返回值设计**：使用不同类型返回值(bool/String)区分不同操作

## 开发经验
- **用户需求平衡**：既要强制学习流程，也要允许用户修改错误
- **数据操作原子性**：保存和删除操作要成对出现，确保数据完整性
- **错误边界处理**：异步操作的每个环节都要有适当的错误处理
- **编译环境管理**：明确区分测试版和正式版的编译方式 --tags flutter 确认页面 取消功能 数据回滚 用户体验 异步安全 编译策略
--tags #流程管理 #评分:8 #有效期:长期
- END

- 2025/06/22 20:26 START
corgi-recite项目上下文感知默写功能开发记录：

## 本次开发成果
1. **数据架构设计**：
   - 创建ContextInfo、Placeholder、Preposition、BlankQuizItem等模型
   - 扩展数据库到v3，新增context_info表支持元信息存储
   - 实现完整的JSON序列化/反序列化和数据库CRUD操作

2. **智能解析器**：
   - ContextParser支持四种元信息标记：{}占位符、[]介词、|多关键词、()词性
   - 智能文本解析，自动提取上下文信息并生成显示文本
   - 填空题生成逻辑，支持传统问答和智能填空混合测试

3. **界面集成**：
   - AddWordScreen支持新的输入格式，用户界面增加上下文格式说明
   - ContextQuizScreen专门处理上下文感知测试，支持传统题和填空题
   - 完整的错误处理和进度保存机制

4. **服务层架构**：
   - ContextQuizService管理智能测试流程
   - 支持双向测试、随机抽查、指定内容测试三种模式
   - 智能答案验证，支持同义词和可接受答案列表

## 发现的新问题
1. **测试流程优化**：背诵后双向测试出错应保存进度并返回背诵，而非立即处理
2. **UI体验问题**：添加词语页面输入框提示文字溢出
3. **填空策略精细化**：四种元信息需要不同的默写策略
   - 词性：任何默写都显示
   - 不定代词：给出答案，只填空其他内容
   - 介词：意项→词语只需填介词和关键词
   - 多关键词：不同方向有不同的显示和填空要求

## 技术架构要点
- **分层设计**：Parser(解析) → Service(业务) → Screen(界面) → Database(存储)
- **向后兼容**：新功能不影响现有词语，支持混合测试模式
- **智能验证**：灵活的答案匹配，支持同义词和多种可接受形式
- **状态管理**：完整的测试状态保存和恢复机制

## 开发经验
- **模型设计**：复杂功能需要完整的数据模型支撑，JSON序列化至关重要
- **渐进开发**：从数据层到服务层再到界面层，逐步构建功能
- **错误处理**：每个异步操作都需要适当的错误处理和用户反馈
- **测试策略**：新功能要保持与现有系统的完全兼容 --tags corgi-recite 上下文感知 填空题 智能测试 数据库升级 Flutter开发
--tags #流程管理 #评分:8 #有效期:长期
- END

- 2025/06/22 20:44 START
corgi-recite项目问题修复和优化开发记录：

## 本次开发内容
1. **双向测试错误处理优化**：
   - 修改SmartQuizScreen，实现双向测试中答错立即保存进度并返回背诵页面
   - 添加_handleBidirectionalError()、_startImmediateReview()、_resumeQuizAfterReview()方法
   - 实现错误后立即背诵→背诵完成→恢复测试进度的完整流程

2. **添加词语页面UI修复**：
   - 修复输入框提示词溢出问题，添加contentPadding和调整hintText格式
   - 优化提示文本布局，避免文字超出输入框范围

3. **四种元信息默写策略设计**：
   - 开始重构ContextParser.generateBlankQuiz()方法，支持QuizDirection参数
   - 设计差异化填空策略：
     * 词性：任何默写中都显示，不要求填空
     * 不定代词：给出答案，只填空其他内容
     * 介词：意项→词语只需填空介词和关键词
     * 多关键词：词语→意项显示所有，意项→词语需要填空
   - 在ContextParser中定义QuizDirection枚举，移除重复定义

## 未完成的问题
1. **BlankType.regular类型缺失**：需要在context_info.dart中添加regular类型到BlankType枚举
2. **_extractNonSpecialWords方法未实现**：需要实现提取非特殊标记词语的逻辑
3. **四种元信息策略未完全实现**：
   - 不定代词的智能显示和填空策略
   - 介词的差异化处理逻辑
   - 多关键词的方向性显示策略
   - 词性的统一显示机制

## 开发经验总结
1. **错误处理流程设计**：立即错误处理比批量错误处理用户体验更好，能及时强化学习
2. **UI细节优化重要性**：小的UI问题（如文字溢出）会影响用户体验，需要重视contentPadding等细节
3. **枚举和类型设计**：跨文件的枚举定义需要统一管理，避免重复定义导致冲突
4. **渐进式重构策略**：复杂功能需要保持向后兼容，先实现新接口再逐步迁移
5. **测试方向差异化**：同一功能在不同测试方向下需要不同的处理策略，需要参数化设计

## 下一步开发计划
1. 完善BlankType枚举，添加regular类型
2. 实现_extractNonSpecialWords方法
3. 完成四种元信息的完整填空策略实现
4. 更新context_quiz_service.dart中的相关调用
5. 测试新的填空策略在实际使用中的效果 --tags corgi-recite 错误处理优化 UI修复 填空策略 测试方向 Flutter开发
--tags #流程管理 #评分:8 #有效期:长期
- END

- 2025/06/22 22:17 START
corgi-recite项目四种元信息差异化填空策略完成开发：

## 完成的四种元信息处理策略
1. **词性策略**：在任何默写中都显示词性(n.)(v.)(adj.)，不要求用户填空
2. **不定代词策略**：
   - 词语→意项：显示不定代词，填空其他内容
   - 意项→词语：显示不定代词，填空其他内容
3. **介词策略**：
   - 词语→意项：显示介词[in][on][at]，不需要填空
   - 意项→词语：只需要默写介词和多关键词，直接给出其他非特殊内容
4. **多关键词策略**：
   - 词语→意项：显示所有关键词big|large|huge，不需要填空
   - 意项→词语：显示除了多关键词和介词以外的所有非特殊内容，只要求填空关键词和介词

## 技术实现要点
1. **BlankType枚举扩展**：在context_info.dart中添加了regular类型支持常规文本填空
2. **_extractNonSpecialWords方法**：实现了提取非特殊标记的常规文本词语的逻辑
3. **方向性填空策略**：
   - _processWordToMeaning()：处理词语→意项的填空策略
   - _processMeaningToWord()：处理意项→词语的填空策略
4. **智能填空逻辑**：根据元信息类型和测试方向动态生成不同的填空模板

## 核心代码架构
- **ContextParser.generateBlankQuiz()**：接受QuizDirection参数，根据方向生成不同填空策略
- **QuizDirection枚举**：定义wordToMeaning和meaningToWord两个测试方向
- **BlankAnswer类型系统**：支持placeholder、preposition、keyword、partOfSpeech、regular五种填空类型
- **智能提示系统**：为不同类型的填空提供针对性的提示信息

## 修复的问题
1. **编译错误修复**：在context_quiz_screen.dart中添加了context_parser.dart的导入
2. **枚举缺失修复**：添加了BlankType.regular类型支持
3. **方法实现补全**：完整实现了_extractNonSpecialWords方法
4. **策略逻辑完善**：按照用户明确要求实现了四种元信息的差异化处理策略

## 开发经验
- **需求理解重要性**：准确理解用户对不同测试方向的特殊要求
- **方向性设计**：同一功能在不同方向下需要完全不同的处理策略
- **代码分层架构**：Parser层处理填空生成，Service层处理业务逻辑，Screen层处理UI交互
- **向后兼容性**：保留了generateBlankQuizLegacy方法确保老代码仍能正常运行
- **参数化策略模式**：通过QuizDirection参数实现同一方法的多种策略
- **智能文本处理**：通过正则表达式和字符串处理实现复杂的文本分析和替换逻辑 --tags corgi-recite 上下文感知 填空策略 四种元信息 差异化处理 方向性测试 Flutter开发
--tags #其他 #评分:8 #有效期:长期
- END

- 2025/06/22 22:54 START
corgi-recite项目修复双向测试错误处理和界面问题开发记录：

## 本次开发完成内容
1. **修复添加词语页面输入框提示词溢出问题**：
   - 简化hintText内容，移除过长的示例文本
   - 添加hintMaxLines: 5限制提示文本行数
   - 确保输入框提示不会超出边界

2. **修复双向测试错误处理重复测试问题**：
   - 在ReciteScreen中添加isImmediateReview参数区分立即复习模式
   - 立即复习模式完成后直接返回原测试，不启动新的双向测试
   - 修改SmartQuizScreen的_startImmediateReview方法传递isImmediateReview=true
   - 修改_resumeQuizAfterReview方法，让用户重新作答当前错题而非跳到下一题

3. **四种差异化默写策略基础架构**：
   - 完成BlankType枚举扩展，添加regular类型
   - 实现_extractNonSpecialWords方法提取非特殊标记文本
   - 完成ContextParser中四种元信息的差异化处理策略
   - 为SmartQuizScreen添加了ContextQuizService引用

## 未完成的问题
1. **四种差异化默写策略未生效**：
   - SmartQuizScreen仍使用旧的QuizService而非ContextQuizService
   - 需要在SmartQuizScreen中集成上下文感知检测和填空界面生成
   - 测试界面需要支持混合显示传统题和填空题

2. **双向测试系统不统一**：
   - 随机抽查错误后的双向测试使用QuizScreen
   - 添加词语后的双向测试使用SmartQuizScreen
   - 两套不同的测试逻辑可能导致用户体验不一致

3. **上下文感知功能集成不完整**：
   - ContextQuizScreen创建但未被实际使用
   - 需要将上下文感知功能完全集成到主测试流程中

## 未完善的解决方案
1. **SmartQuizScreen上下文感知集成方案**：
   - 在_setupCurrentQuestion中检测当前QuizItem是否有对应的上下文信息
   - 动态生成填空输入框替代单一输入框
   - 在_submitAnswer中使用ContextQuizService的验证逻辑
   - 支持传统题和填空题混合显示

2. **测试系统统一方案**：
   - 将所有双向测试统一使用SmartQuizScreen
   - 或者将所有测试统一迁移到支持上下文感知的ContextQuizScreen
   - 确保用户体验一致性

## 开发经验总结
1. **参数传递区分模式**：通过添加isImmediateReview参数成功区分了不同的背诵模式，避免了重复测试
2. **界面问题定位**：UI溢出问题通过简化内容和设置限制参数快速解决
3. **错误处理流程设计**：正确的错误处理应该让用户重新作答当前题目，而非跳过或创建新测试
4. **系统架构一致性重要性**：多套测试逻辑导致维护困难和用户体验不一致
5. **渐进式重构策略**：在时间有限的情况下，优先解决影响用户体验的关键问题
6. **上下文感知功能复杂性**：需要在多个层面（数据生成、界面显示、答案验证）进行集成

## 技术债务
1. **代码重复**：QuizService和ContextQuizService功能重叠
2. **界面不统一**：SmartQuizScreen和ContextQuizScreen功能相似但分离
3. **测试流程分散**：多个入口使用不同的测试逻辑
4. **上下文检测缺失**：现有测试界面无法自动检测和应用上下文信息

## 下一步开发建议
1. 统一测试系统架构，选择一个主要的测试界面
2. 完整集成上下文感知功能到主测试流程
3. 重构测试服务，合并重复逻辑
4. 全面测试四种元信息的差异化策略
5. 确保所有测试入口使用相同的逻辑和界面 --tags corgi-recite 双向测试 错误处理 界面修复 上下文感知 系统架构 Flutter开发
--tags #流程管理 #评分:8 #有效期:长期
- END